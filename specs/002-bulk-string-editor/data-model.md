# Data Model: Bulk String Editor

**Feature**: 002-bulk-string-editor
**Date**: 2026-02-15

## Existing Entities (No Schema Changes)

This feature operates entirely on existing database tables. No migrations required.

### strings

Represents a translatable string key within a project.

| Field        | Type        | Constraints                                    | Description                                  |
| ------------ | ----------- | ---------------------------------------------- | -------------------------------------------- |
| `id`         | `text`      | PK                                             | UUIDv7 generated by `Bun.randomUUIDv7()`     |
| `key`        | `text`      | NOT NULL, `LENGTH(TRIM(key)) > 0`              | Unique string identifier within project      |
| `context`    | `text`      | nullable                                       | Optional context/description for translators |
| `project_id` | `text`      | NOT NULL, FK → `projects.id` ON DELETE CASCADE | Owning project                               |
| `created_at` | `timestamp` | NOT NULL, default `now()`                      | Creation timestamp                           |
| `updated_at` | `timestamp` | NOT NULL, default `now()`, auto-update         | Last modification timestamp                  |

**Constraints**: `UNIQUE(key, project_id)`
**Indexes**: `strings_project_id_idx` on `project_id`

### translations

Stores individual locale translations for each string.

| Field        | Type        | Constraints                                   | Description                          |
| ------------ | ----------- | --------------------------------------------- | ------------------------------------ |
| `id`         | `text`      | PK                                            | UUIDv7                               |
| `string_id`  | `text`      | NOT NULL, FK → `strings.id` ON DELETE CASCADE | Parent string                        |
| `locale`     | `text`      | NOT NULL, `LENGTH(TRIM(locale)) > 0`          | Locale code (e.g., `en`, `fr`, `de`) |
| `value`      | `text`      | NOT NULL                                      | Translated text                      |
| `created_at` | `timestamp` | NOT NULL, default `now()`                     | Creation timestamp                   |
| `updated_at` | `timestamp` | NOT NULL, default `now()`, auto-update        | Last modification timestamp          |

**Constraints**: `UNIQUE(string_id, locale)`
**Indexes**: `translations_string_id_locale_idx` on `(string_id, locale)`

### translation_snapshots

Immutable published versions of translations for a locale.

| Field        | Type        | Constraints                                    | Description                                                    |
| ------------ | ----------- | ---------------------------------------------- | -------------------------------------------------------------- |
| `id`         | `text`      | PK                                             | UUIDv7                                                         |
| `project_id` | `text`      | NOT NULL, FK → `projects.id` ON DELETE CASCADE | Owning project                                                 |
| `locale`     | `text`      | NOT NULL                                       | Locale code                                                    |
| `version`    | `integer`   | NOT NULL                                       | Incrementing version number                                    |
| `data`       | `jsonb`     | NOT NULL                                       | `Record<string, string>` — all key-value pairs at publish time |
| `created_at` | `timestamp` | NOT NULL, default `now()`                      | Publish timestamp                                              |

**Constraints**: `UNIQUE(project_id, locale, version)`
**Indexes**: `(project_id, locale, version)`, `(project_id, locale)`

### projects

Referenced for authorization and locale configuration.

| Field             | Type     | Constraints                                | Description                       |
| ----------------- | -------- | ------------------------------------------ | --------------------------------- |
| `id`              | `text`   | PK                                         | UUIDv7                            |
| `name`            | `text`   | NOT NULL                                   | Project display name              |
| `default_locale`  | `text`   | NOT NULL                                   | Primary locale                    |
| `enabled_locales` | `text[]` | NOT NULL                                   | Array of all enabled locale codes |
| `public_key`      | `text`   | NOT NULL                                   | Public API key                    |
| `user_id`         | `text`   | NOT NULL, FK → `user.id` ON DELETE CASCADE | Owner                             |

## Frontend State Entities

### BulkEditorRow

Represents one row in the bulk editor table (one string + all its translations).

```typescript
interface BulkEditorRow {
  stringKey: string;
  context: string | null;
  translations: Record<string, string>;
}
```

**Source**: Derived from `GET /app-api/v1/s/:projectId` response. Each `StringResponse` maps to one `BulkEditorRow`.

### DirtyEdits

Tracks all unsaved modifications in the current editing session.

```typescript
type DirtyEdits = Map<string, Record<string, string>>;
```

**Key**: String key (e.g., `"welcome_message"`)
**Value**: Object mapping locale codes to modified translation values (e.g., `{ "fr": "Bienvenue", "de": "Willkommen" }`)

**State transitions**:

- Empty → Has entries: User edits a cell
- Has entries → Empty: User saves successfully OR user discards changes
- Has entries → Has entries: User edits another cell or modifies existing edit

### ColumnVisibility

Tracks which locale columns are visible.

```typescript
type ColumnVisibility = Record<string, boolean>;
```

**Key**: Column ID (locale code or `"key"` or `"context"`)
**Value**: `true` = visible, `false` = hidden

**Default**: All columns visible. Persisted in React state (session only, per FR-015).

### BulkEditorFilter

Tracks the current search/filter state.

```typescript
interface BulkEditorFilter {
  searchQuery: string;
}
```

**Source**: URL search params (`?q=search_term`)
**Behavior**: Filters rows where string key OR any translation value contains the search query (case-insensitive)

## Entity Relationships

```
projects (1) ──── (N) strings (1) ──── (N) translations
    │
    └──── (N) translation_snapshots
```

**Bulk editor data flow**:

1. Load: `GET /s/:projectId` → `StringResponse[]` → `BulkEditorRow[]`
2. Edit: User modifies cells → updates `DirtyEdits` map
3. Save: Convert `DirtyEdits` → `TranslationEntry[]` → `PUT /s/:projectId/translations`
4. Publish: `POST /p/:projectId/publish` with selected locales

## Validation Rules

| Field                  | Rule                                       | Source                         |
| ---------------------- | ------------------------------------------ | ------------------------------ |
| `translations[locale]` | Max 10,000 characters                      | Application-level limit        |
| `translations[locale]` | Locale must be in `project.enabledLocales` | Validated on server via schema |
| `string.key`           | Non-empty after trim                       | Database CHECK constraint      |
| `locale`               | Non-empty after trim                       | Database CHECK constraint      |
| Bulk save payload      | At least 1 entry                           | Zod schema `min(1)`            |
